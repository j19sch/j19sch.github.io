<!DOCTYPE html>
<html prefix="
og: http://ogp.me/ns# article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>(clj 4) Learning about when, maps and closures | Joep Schuurkes</title>
<link href="../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../../rss.xml">
<link rel="alternate" type="application/atom+xml" title="Atom" href="../../../feed.atom">
<link rel="canonical" href="https://j19sch.github.io/blog/clojure/2020/clj4-learning-when-maps-closures/">
<!--[if lt IE 9]><script src="../../../../assets/js/html5.js"></script><![endif]--><script>var clicky_site_ids = clicky_site_ids || []; clicky_site_ids.push(101252313);</script><script async src="//static.getclicky.com/js"></script><meta name="author" content="Joep Schuurkes">
<link rel="prev" href="../../../2020/its-time-to-retire-our-test-case-management-tools/" title="It's time to retire our test case management tools" type="text/html">
<link rel="next" href="../clj5-loop-and-recur-into-and-conj/" title="(clj 5) Loop and recur, into and conj" type="text/html">
<meta property="og:site_name" content="Joep Schuurkes">
<meta property="og:title" content="(clj 4) Learning about when, maps and closures">
<meta property="og:url" content="https://j19sch.github.io/blog/clojure/2020/clj4-learning-when-maps-closures/">
<meta property="og:description" content="It's been more than two months since I did any Clojure - for the obvious reasons. Luckily I did take notes as I proceeded with chapter 3 of &quot;Clojure for the Brave and True&quot;. So the plan is to process ">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2020-07-31T22:25:15+02:00">
<meta property="article:tag" content="brave-true">
<meta property="article:tag" content="clojure">
<meta property="article:tag" content="closures">
<meta property="article:tag" content="maps">
<meta property="article:tag" content="when">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Header and menu bar -->
<div class="container">
      <header class="blog-header py-3"><div class="row nbb-header align-items-center">
          <div class="col-md-3 col-xs-2 col-sm-2" style="width: auto;">
            <button class="navbar-toggler navbar-light bg-light nbb-navbar-toggler" type="button" data-toggle="collapse" data-target=".bs-nav-collapsible" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse bs-nav-collapsible bootblog4-search-form-holder">
                
            </div>
        </div>
          <div class="col-md-6 col-xs-10 col-sm-10 bootblog4-brand" style="width: auto;">
            <a class="navbar-brand blog-header-logo text-dark" href="https://j19sch.github.io/">

            <span id="blog-title">Joep Schuurkes</span>
        </a>
          </div>
            <div class="col-md-3 justify-content-end align-items-center bs-nav-collapsible collapse flex-collapse bootblog4-right-nav">
            <nav class="navbar navbar-light bg-white"><ul class="navbar-nav bootblog4-right-nav"></ul></nav>
</div>
    </div>
</header><nav class="navbar navbar-expand-md navbar-light bg-white static-top"><div class="collapse navbar-collapse bs-nav-collapsible" id="bs-navbar">
            <ul class="navbar-nav nav-fill d-flex w-100">
<li class="nav-item">
<a href="../../../../index.html" class="nav-link">Home</a>
                </li>
<li class="nav-item">
<a href="../../../../my-projects" class="nav-link">Projects</a>
                </li>
<li class="nav-item">
<a href="../../../../my-talks" class="nav-link">Talks</a>
            </li>
<li class="nav-item dropdown">
<a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Lists</a>
            <div class="dropdown-menu">
                    <a href="../../../../my-lists/reading-list" class="dropdown-item">Reading list</a>
                    <a href="../../../../my-lists/recommended-reading" class="dropdown-item">Recommended reading</a>
                    <a href="../../../../my-lists/favorite-podcasts" class="dropdown-item">Favorite podcasts</a>
                    <a href="../../../../my-lists/fountain-pens" class="dropdown-item">Fountain pens</a>
            </div>
            </li>
<li class="nav-item dropdown">
<a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Blog</a>
            <div class="dropdown-menu">
                    <a href="../../../../blog" class="dropdown-item">My blog</a>
                    <a href="../../../../categories/" class="dropdown-item">Categories and tags</a>
                    <a href="../../../rss.xml" class="dropdown-item">RSS feed</a>
                    <a href="../../../feed.atom" class="dropdown-item">Atom feed</a>
            </div>

                
            </li>
</ul>
</div>
<!-- /.navbar-collapse -->
</nav>
</div>

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">(clj 4) Learning about when, maps and closures</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    Joep Schuurkes
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2020-07-31T22:25:15+02:00" itemprop="datePublished" title="31 July 2020">31 July 2020</time></a>
            </p>
            
        </div>
        
    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<p>It's been more than two months since I did any Clojure - for the obvious reasons. Luckily I did take notes as I proceeded with chapter 3 of "<a href="https://www.braveclojure.com/">Clojure for the Brave and True</a>". So the plan is to process these notes into a blog post, which means this post will cover the sections "Data Structures" and "Functions" of that third chapter. Leaving me ready to proceed with the rest of the chapter, i.e. "Pulling It All Together" and the summary and exercises.</p>
<h3>Why is there a <code>when</code>?</h3>
<p>The part about control flow is actually before the part about <code>and</code> and <code>or</code> which I talked about in my <a href="../../../clj3-and-or-being-weird">previous post</a>, but according to my notes I returned to it. I don't remember why to be honest.</p>
<p>The book provides the following example of <code>when</code>:</p>
<pre class="code literal-block"><span></span><span class="p">(</span><span class="nb">when </span><span class="nv">true</span>
    <span class="p">(</span><span class="nb">println </span><span class="s">"Success!"</span><span class="p">)</span>
    <span class="s">"abra cadabra"</span><span class="p">)</span>
<span class="c1">; =&gt; Success!</span>
<span class="c1">; =&gt; "abra cadabra"</span>
</pre>


<!-- TEASER_END -->

<p>And if the condition is <code>false</code>, you get:</p>
<pre class="code literal-block"><span></span><span class="p">(</span><span class="nb">when </span><span class="nv">false</span>
    <span class="p">(</span><span class="nb">println </span><span class="s">"First do!"</span><span class="p">)</span>
    <span class="s">"By Odin's Elbow!"</span><span class="p">)</span>
<span class="c1">; =&gt; nil</span>
</pre>


<p>So <code>when</code> allows you to do several things and return something when the condition is <code>true</code>, while it will return <code>nil</code> if the condition is <code>false</code>. The thing that got me curious is that you can do the same thing almost as easily with <code>if</code> and <code>do</code>:</p>
<pre class="code literal-block"><span></span><span class="p">(</span><span class="k">if </span><span class="nv">true</span>
  <span class="p">(</span><span class="k">do </span><span class="p">(</span><span class="nb">println </span><span class="s">"Success!"</span><span class="p">)</span>
      <span class="s">"abra cadabra"</span><span class="p">)</span>
  <span class="p">)</span>
<span class="c1">; =&gt; Success!</span>
<span class="c1">; =&gt; "abra cadabra"</span>

<span class="p">(</span><span class="k">if </span><span class="nv">false</span>
  <span class="p">(</span><span class="k">do </span><span class="p">(</span><span class="nb">println </span><span class="s">"First do!"</span><span class="p">)</span>
      <span class="s">"By Odin's Elbow!"</span><span class="p">)</span>
  <span class="p">)</span>
<span class="c1">; =&gt; nil</span>
</pre>


<p>I can see two advantages to having the <code>when</code>. It needs fewer characters: two brackets and a space. It's also more readable, since there is no <code>do</code> and no indentation decisions because of that <code>do</code>. Is that enough reason? I honestly don't know, because I haven't written enough Clojure to decide if you use <code>when</code> often enough to make it worth it having it.</p>
<p>There is another difference, however, which I found out thanks to <a href="https://github.com/tpope/vim-fireplace">vim-fireplace</a>'s <code>K</code> command, which looks up the symbol under the cursor with <code>doc</code>. <code>if</code> and <code>do</code> are Special Forms, while <code>when</code> is a Macro. What difference that makes, I don't know yet. In the section about functions in the same chapter, it does say on page 126:</p>
<blockquote>
<p>You’ll learn everything there is to know about macro calls and special forms in Chapter 7. For now, the main feature that makes special forms “special” is that, unlike function calls, they don’t always evaluate all of their operands.</p>
</blockquote>
<p>And on page 127:</p>
<blockquote>
<p>Macros are similar to special forms in that they evaluate their operands differently from function calls, and they also can’t be passed as arguments to functions.</p>
</blockquote>
<p>I made a note to revisit this when I get to Chapter 7. So one day there should be a link to that post here.</p>
<h3>Maps</h3>
<p>With my Python background I had some trouble with the syntax of maps. With keywords being used as keys, they look like this:</p>
<pre class="code literal-block"><span></span><span class="p">{</span><span class="ss">:first-name</span> <span class="s">"Charlie"</span>
 <span class="ss">:last-name</span> <span class="s">"McFishwich"</span><span class="p">}</span>
</pre>


<p>So the same characters as a Python dictionary but in a different order. This made me appreciate the value of practice. I won't be enjoying writing Clojure if I mess up the syntax of maps every time because of Python muscle memory.</p>
<p>Practice wasn't without its hurdles, though. When I defined a map and evaluated it like this:</p>
<pre class="code literal-block"><span></span><span class="p">(</span><span class="k">def </span><span class="nv">my-other-map</span> <span class="p">(</span><span class="nb">hash-map </span><span class="ss">:a</span> <span class="mi">100</span> <span class="ss">:b</span> <span class="mi">101</span> <span class="ss">:c</span> <span class="mi">102</span><span class="p">))</span>
<span class="p">(</span><span class="nf">my-other-map</span><span class="p">)</span>
</pre>


<p>I got the error <code>ArityException Wrong number of args (0) passed to: PersistentArrayMap  clojure.lang.AFn.throwArity (AFn.java:429)</code>. </p>
<p>Removing ther parantheses around the map's name resulted in:</p>
<pre class="code literal-block"><span></span>Error detected while processing function &lt;SNR&gt;48_printop[1]..&lt;SNR&gt;48_opfunc[40]..function &lt;SNR&gt;48_printop[1]..&lt;SNR&gt;48_opfunc:
line   21:
E20: Mark not set
E20: Mark not set
Press ENTER or type command to continue
</pre>


<p>The solution turned out to be to not have the parantheses (so just <code>my-other-map</code> on its own line), but then not use <code>cpp</code> to evaluate the statement, which evaluates the innermost statement, but use <code>cp$</code> (evaluate until end of the line) or <code>cp_</code> (evaluate current line).</p>
<p>Trying to evaluate the innermost form of a string in parantheses, gave me an impressive error message as well:</p>
<pre class="code literal-block"><span></span>ClassCastException class java.lang.String cannot be cast to class clojure.lang.IFn (java.lang.String is in module java.base of loader 'bootstrap'; clojure.lang.IFn is in unnamed module of loader 'app')  clojure-noob.core/eval6974 (form-init11099437324952859876.clj:5)
</pre>


<p>My notes tell me I didn't understand what exactly was going on here. Today, while writing this blog post, I went back in the book to the start of the chapter and there it explains that Clojure recognizes two kinds of structures: literal representations of data structures and operations. All operations take the form of opening parenthesis, operator, operands, closing parenthesis. Me putting the name of my hash map or a string literal in parantheses is neither of those structures, so makes sense I get an error.</p>
<p>Then for the scope of evaluation, <code>cpp</code> evaluates the innermost form. However I am on a line with just the name of my map, so I'm not sure what it tries to evaluate. Perhaps the whole file? In any case it's not what I want to evaluate, so it's ok that it throws an error instead of working.</p>
<p>Finally, I was surprised that all these three ways to get a value from a map are part of the language:</p>
<pre class="code literal-block"><span></span><span class="p">(</span><span class="k">def </span><span class="nv">my-map</span> <span class="p">{</span><span class="ss">:a</span> <span class="mi">0</span> <span class="ss">:b</span> <span class="p">{</span><span class="ss">:c</span> <span class="s">"ho hum"</span><span class="p">}})</span>

<span class="p">(</span><span class="nb">get </span><span class="nv">my-map</span> <span class="ss">:a</span><span class="p">)</span>
<span class="c1">; =&gt; 0</span>

<span class="p">(</span><span class="nf">my-map</span> <span class="ss">:a</span><span class="p">)</span>
<span class="c1">; =&gt; 0</span>

<span class="p">(</span><span class="ss">:a</span> <span class="nv">my-map</span><span class="p">)</span>
<span class="c1">; =&gt; 0</span>
</pre>


<h3>Functions and returning functions</h3>
<p>The section about functions ends with the following explanation about returning functions:</p>
<blockquote>
<p>By now you’ve seen that functions can return other functions. The returned functions are <em>closures</em>, which means that they can access all the variables that were in scope when the function was created. Here’s a standard example:</p>
</blockquote>
<pre class="code literal-block"><span></span><span class="p">(</span><span class="nf">defn</span> <span class="nv">inc-maker</span>
  <span class="s">"Create a custom incrementor"</span>
  <span class="p">[</span><span class="nv">inc-by</span><span class="p">]</span>
  <span class="o">#</span><span class="p">(</span><span class="nf">+</span> <span class="nv">%</span> <span class="nv">inc-by</span><span class="p">))</span>


<span class="p">(</span><span class="nf">def</span> <span class="nv">inc3</span> <span class="p">(</span><span class="nf">inc-maker</span> <span class="mi">3</span><span class="p">))</span>
<span class="p">(</span><span class="nf">inc3</span> <span class="mi">7</span><span class="p">)</span>
<span class="c1">; =&gt; 10</span>
</pre>


<blockquote>
<p>Here, <code>inc-by</code> is in scope, so the returned function has access to it even when the returned function is used outside <code>inc-maker</code>.</p>
</blockquote>
<p>I do not understand this explanation. In my mind the <code>inc-maker</code> returns a function that adds 3 to a number, so basically <code>(defn inc3 [number] (+ number 3))</code>, and I don't see how the scope of <code>inc-by</code> comes into play. (I am noticing now though that in the example <code>def</code> is used, not <code>defn</code> to create the <code>inc3</code> function.) So now I have some code that does make sense to me, while the explanation of the code doesn't, which is a somewhat weird place to be in.</p>
<p>In the hope of figuring this out I checked Wikipedia which says about <a href="https://en.wikipedia.org/wiki/Closure_(computer_programming)">clojures</a>: "Operationally, a closure is a record storing a function together with an environment." Which is in line with the explanation quoted above, but it doesn't help me understand.</p>
<p>It doesn't help either that the name of this language, Clojure, is a pun on the term 'closure', which makes me feel it is important to understand them. Some more searching didn't get me anything useful, although I did find <a href="https://groups.google.com/forum/#!msg/clojure/4uDxeOS8pwY/UHiYp7p1a3YJ">this post</a> from <a href="https://twitter.com/richhickey">Rich Hickey</a> about naming Clojure "Clojure":</p>
<blockquote>
<p>The name was chosen to be unique. I wanted to involve c (c#), l (lisp)
and j (java).</p>
<p>Once I came up with Clojure, given the pun on closure, the available
domains and vast emptiness of the googlespace, it was an easy
decision.</p>
</blockquote>
<p>And that's where I decided to accept I would not be understanding why closures are important when functions return other functions. Except that after writing the previous sentence, I started wondering if I could construct a more complicated function that returns a function, that would help me understand. I failed to construct such a function, since it wouldn't accept me binding a variable in either of the ways I tried to.</p>
<p>In any case, hopefully I will understand this one day. It does leave me with the feeling that the explanation about closures doesn't need to be in this part of the book. Perhaps it would be more in its place in chapter 7 which describes how Clojure runs your code.</p>
<hr>
<p>As I did in my previous post, this postscript contains some smaller things I noticed and/or learned.</p>
<h4>Notes on blogging</h4>
<p>Thanks to the combination of my notes, my play-around files and some re-playing around, it was fairly easy to write this blog post. I don't like leaving such a gap between learning and blogging, but it's good to know that when it happens, it's not a problem.</p>
<h4>Notes on Vim</h4>
<p>I had to relearn a few things. Vim-fireplace will not connect to the REPL if you don't start one with <code>lein repl</code> first. Use <code>"+</code> in Vim to copy-paste to the system clipboard (thank you past me for the <a href="(/my-projects/clojure-vim-cheatsheet)">cheatsheet</a>).</p>
<p>Changing to gruvbox as Vim theme was a good idea. I did have to move the colorscheme line in my <code>.vimrc</code> because the statusbar was not green in normal mode.</p>
<p>In my previous post's postscrpit I was wondering how to get the result of an evaluation into my file. I have found a way, but it's quite a few keystrokes: copy the thing, paste the thing, evaluate it with <code>c!{motion}</code> which replaces it with the result of the evaluation, then <code>gcc</code> to make it into a comment. I might need to make a custom vim command to make that easier.</p>
<p>According to my notes I used <code>ctrl+n</code> (next match) and <code>ctrl+p</code> (previous match) for auto-completion, so I added those to my cheatsheet.</p>
</div>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../../../categories/brave-true/" rel="tag">brave-true</a></li>
            <li><a class="tag p-category" href="../../../../categories/clojure/" rel="tag">clojure</a></li>
            <li><a class="tag p-category" href="../../../../categories/closures/" rel="tag">closures</a></li>
            <li><a class="tag p-category" href="../../../../categories/maps/" rel="tag">maps</a></li>
            <li><a class="tag p-category" href="../../../../categories/when/" rel="tag">when</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../../../2020/its-time-to-retire-our-test-case-management-tools/" rel="prev" title="It's time to retire our test case management tools">Previous post</a>
            </li>
            <li class="next">
                <a href="../clj5-loop-and-recur-into-and-conj/" rel="next" title="(clj 5) Loop and recur, into and conj">Next post</a>
            </li>
        </ul></nav></aside></article><!--End of body content--><footer id="footer">
            Contents © 2021     
<a href="http://creativecommons.org/licenses/by/4.0/">
<img alt="Creative Commons License" style="border-width:0;margin: 0px 0px 0px 0px" src="https://i.creativecommons.org/l/by/4.0/80x15.png"></a>
    <a href="mailto:j19sch@gmail.com">Joep Schuurkes</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>
            
        </footer>
</div>
</div>

        <script src="../../../../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script>
</body>
</html>
